# See https://docs.aspect.build/workflows/configuration
tasks:
  - checkout:
      update_strategy: rebase
  - lint:
  - format:
  - test:
      targets:
        - //...
        - -//speller/...
      bazel:
        flags:
          -  --config=rbe
          -  --test_tag_filters=-skip-on-aspect-workflows
      coverage:
        codecov_upload: true
  - delivery:
      hooks:
        - type: before_task
          command: |
            mkdir -p /tmp/docker-config
            echo '{}' > /tmp/docker-config/config.json
            DOCKER_CONFIG=/tmp/docker-config \
              echo $GITHUB_TOKEN | docker login $REGISTRY -u $GITHUB_ACTOR --password-stdin
      rules:
        - deliverable: 'kind("oci_push rule", //...)'
notifications:
  github: {}
